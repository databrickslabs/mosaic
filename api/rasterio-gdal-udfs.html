<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rasterio + GDAL UDFs &mdash; Mosaic</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Usage" href="../usage/usage.html" />
    <link rel="prev" title="Raster functions" href="raster-functions.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Mosaic
              <img src="../_static/mosaic_logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="api.html">API Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="vector-format-readers.html">Vector Format Readers</a></li>
<li class="toctree-l2"><a class="reference internal" href="raster-format-readers.html">Raster Format Readers</a></li>
<li class="toctree-l2"><a class="reference internal" href="geometry-constructors.html">Geometry constructors</a></li>
<li class="toctree-l2"><a class="reference internal" href="geometry-accessors.html">Geometry accessors</a></li>
<li class="toctree-l2"><a class="reference internal" href="spatial-functions.html">Spatial functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="spatial-indexing.html">Spatial grid indexing</a></li>
<li class="toctree-l2"><a class="reference internal" href="spatial-predicates.html">Spatial predicates</a></li>
<li class="toctree-l2"><a class="reference internal" href="spatial-aggregations.html">Spatial aggregation functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="raster-functions.html">Raster functions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Rasterio + GDAL UDFs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../usage/usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../literature/videos.html">Mosaic Videos and Talks</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Mosaic</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="api.html">API Documentation</a></li>
      <li class="breadcrumb-item active">Rasterio + GDAL UDFs</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/api/rasterio-gdal-udfs.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="rasterio-gdal-udfs">
<h1>Rasterio + GDAL UDFs<a class="headerlink" href="#rasterio-gdal-udfs" title="Permalink to this heading"></a></h1>
<section id="intro">
<h2>Intro<a class="headerlink" href="#intro" title="Permalink to this heading"></a></h2>
<p>Rasterio (<a class="reference external" href="https://rasterio.readthedocs.io/en/latest/">https://rasterio.readthedocs.io/en/latest/</a>) is a Python library for reading and writing geospatial raster datasets.
It uses GDAL (<a class="reference external" href="https://gdal.org/">https://gdal.org/</a>) for file I/O and raster formatting and provides a Python API for GDAL functions.
It is a great library for working with raster data in Python and it is a popular choice for many geospatial data scientists.
Rasterio UDFs provide a way to use Rasterio Python API in Spark for distributed processing of raster data.
The data structures used by Mosaic are compatible with Rasterio and can be used interchangeably.
In this section we will show how to use Rasterio UDFs to process raster data in Mosaic + Spark.
We assume that you have a basic understanding of Rasterio and GDAL. We also provide an example which directly calls GDAL
Translate and Warp.</p>
<p>Please note that we advise the users to set these configuration to ensure proper distribution.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.execution.arrow.enabled&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.execution.arrow.maxRecordsPerBatch&quot;</span><span class="p">,</span> <span class="s2">&quot;1024&quot;</span><span class="p">)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.execution.arrow.fallback.enabled&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.adaptive.coalescePartitions.enabled&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.shuffle.partitions&quot;</span><span class="p">,</span> <span class="s2">&quot;400&quot;</span><span class="p">)</span> <span class="c1"># maybe higher, depending</span>
</pre></div>
</div>
</section>
<section id="rasterio-raster-plotting">
<h2>Rasterio raster plotting<a class="headerlink" href="#rasterio-raster-plotting" title="Permalink to this heading"></a></h2>
<p>In this example we will show how to plot a raster file using Rasterio Python API.</p>
<p>Firstly we will create a spark DataFrame from a directory of raster files.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;gdal&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;dbfs:/path/to/raster/files&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span>                                                      <span class="n">path</span> <span class="o">|</span>             <span class="n">modificationTime</span> <span class="o">|</span>    <span class="n">length</span> <span class="o">|</span>                <span class="n">uuid</span> <span class="o">|</span> <span class="n">ySize</span> <span class="o">|</span> <span class="n">xSize</span> <span class="o">|</span> <span class="n">bandCount</span> <span class="o">|</span>             <span class="n">metadata</span> <span class="o">|</span> <span class="n">subdatasets</span> <span class="o">|</span>  <span class="n">srid</span> <span class="o">|</span>                                                                                                          <span class="n">tile</span> <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">424495268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660514</span> <span class="o">|</span> <span class="mi">7836235824828840960</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097928191</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">524425268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">212060218</span> <span class="o">|</span> <span class="mi">7836235824828840961</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097927192</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/</span><span class="mf">1241323268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660897</span> <span class="o">|</span> <span class="mi">7836235824828840962</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097929991</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                                                       <span class="o">|</span> <span class="o">...</span>                          <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                 <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                  <span class="o">|</span> <span class="o">...</span>         <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>                                                                                                           <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
</pre></div>
</div>
<p>Next we will define a function that will plot a given raster file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.io</span> <span class="kn">import</span> <span class="n">MemoryFile</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>

<span class="k">def</span> <span class="nf">plot_raster</span><span class="p">(</span><span class="n">raster</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">MemoryFile</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">raster</span><span class="p">))</span> <span class="k">as</span> <span class="n">memfile</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">memfile</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">show</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>Finally we will apply the function to the DataFrame collected results.
Note that in order to plot the raster we need to collect the results to the driver.
Please apply reasonable filters to the DataFrame before collecting the results.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plot_raster</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;tile&quot;</span><span class="p">][</span><span class="s2">&quot;raster&quot;</span><span class="p">])</span>
</pre></div>
</div>
<figure class="doc-figure align-default" id="id1">
<img alt="../_images/plot_raster.png" src="../_images/plot_raster.png" />
<figcaption>
<p><span class="caption-text">Fig 1. Plot raster using Rasterio Python API</span><a class="headerlink" href="#id1" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="udf-example-for-computing-band-statistics">
<h2>UDF example for computing band statistics<a class="headerlink" href="#udf-example-for-computing-band-statistics" title="Permalink to this heading"></a></h2>
<p>In this example we will show how to compute band statistics for a raster file.</p>
<p>Firstly we will create a spark DataFrame from a directory of raster files.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;gdal&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;dbfs:/path/to/raster/files&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span>                                                      <span class="n">path</span> <span class="o">|</span>             <span class="n">modificationTime</span> <span class="o">|</span>    <span class="n">length</span> <span class="o">|</span>                <span class="n">uuid</span> <span class="o">|</span> <span class="n">ySize</span> <span class="o">|</span> <span class="n">xSize</span> <span class="o">|</span> <span class="n">bandCount</span> <span class="o">|</span>             <span class="n">metadata</span> <span class="o">|</span> <span class="n">subdatasets</span> <span class="o">|</span>  <span class="n">srid</span> <span class="o">|</span>                                                                                                          <span class="n">tile</span> <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">424495268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660514</span> <span class="o">|</span> <span class="mi">7836235824828840960</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097928191</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">524425268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">212060218</span> <span class="o">|</span> <span class="mi">7836235824828840961</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097927192</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/</span><span class="mf">1241323268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660897</span> <span class="o">|</span> <span class="mi">7836235824828840962</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097929991</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                                                       <span class="o">|</span> <span class="o">...</span>                          <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                 <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                  <span class="o">|</span> <span class="o">...</span>         <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>                                                                                                           <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
</pre></div>
</div>
<p>Next we will define a function that will compute band statistics for a given raster file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.io</span> <span class="kn">import</span> <span class="n">MemoryFile</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>

<span class="nd">@udf</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_band_mean</span><span class="p">(</span><span class="n">raster</span><span class="p">):</span>
  <span class="k">with</span> <span class="n">MemoryFile</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">raster</span><span class="p">))</span> <span class="k">as</span> <span class="n">memfile</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">memfile</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">dataset</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span><span class="n">bidx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span>
</pre></div>
</div>
<p>Finally we will apply the function to the DataFrame.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">compute_band_mean</span><span class="p">(</span><span class="s2">&quot;tile.raster&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="o">+----------------------------+</span>
<span class="o">|</span> <span class="n">compute_band_mean</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>  <span class="o">|</span>
<span class="o">+----------------------------+</span>
<span class="o">|</span>         <span class="mf">0.0111000000000000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mf">0.0021000000000000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mf">0.3001000000000000</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                        <span class="o">|</span>
<span class="o">+----------------------------+</span>
</pre></div>
</div>
</section>
<section id="udf-example-for-computing-ndvi">
<h2>UDF example for computing NDVI<a class="headerlink" href="#udf-example-for-computing-ndvi" title="Permalink to this heading"></a></h2>
<p>In this example we will show how to compute NDVI for a raster file.
NDVI is a common index used to assess vegetation health.
It is computed as follows: ndvi = (nir - red) / (nir + red).
NDVI output is a single band raster file with values in the range [-1, 1].
We will show how to return a raster object as a result of a UDF.</p>
<p>Firstly we will create a spark DataFrame from a directory of raster files.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;gdal&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;dbfs:/path/to/raster/files&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span>                                                      <span class="n">path</span> <span class="o">|</span>             <span class="n">modificationTime</span> <span class="o">|</span>    <span class="n">length</span> <span class="o">|</span>                <span class="n">uuid</span> <span class="o">|</span> <span class="n">ySize</span> <span class="o">|</span> <span class="n">xSize</span> <span class="o">|</span> <span class="n">bandCount</span> <span class="o">|</span>             <span class="n">metadata</span> <span class="o">|</span> <span class="n">subdatasets</span> <span class="o">|</span>  <span class="n">srid</span> <span class="o">|</span>                                                                                                          <span class="n">tile</span> <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">424495268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660514</span> <span class="o">|</span> <span class="mi">7836235824828840960</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097928191</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">524425268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">212060218</span> <span class="o">|</span> <span class="mi">7836235824828840961</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097927192</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/</span><span class="mf">1241323268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660897</span> <span class="o">|</span> <span class="mi">7836235824828840962</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097929991</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                                                       <span class="o">|</span> <span class="o">...</span>                          <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                 <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                  <span class="o">|</span> <span class="o">...</span>         <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>                                                                                                           <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
</pre></div>
</div>
<p>Next we will define a function that will compute NDVI for a given raster file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.io</span> <span class="kn">import</span> <span class="n">MemoryFile</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>

<span class="nd">@udf</span><span class="p">(</span><span class="s2">&quot;binary&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_ndvi</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">nir_band</span><span class="p">,</span> <span class="n">red_band</span><span class="p">):</span>
  <span class="k">with</span> <span class="n">MemoryFile</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">raster</span><span class="p">))</span> <span class="k">as</span> <span class="n">memfile</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">memfile</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">dataset</span><span class="p">:</span>
      <span class="n">red</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">red_band</span><span class="p">)</span>
      <span class="n">nir</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nir_band</span><span class="p">)</span>
      <span class="n">ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nir</span> <span class="o">-</span> <span class="n">red</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nir</span> <span class="o">+</span> <span class="n">red</span><span class="p">)</span>
      <span class="n">profile</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">profile</span>
      <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
      <span class="c1"># Write the NDVI to a tmp file and return it as binary</span>
      <span class="c1"># This is a workaround an issue occurring when using</span>
      <span class="c1"># MemoryFile for writing using an updated profile</span>
      <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
          <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ndvi</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">rasterio</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>Finally we will apply the function to the DataFrame.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">compute_ndvi</span><span class="p">(</span><span class="s2">&quot;tile.raster&quot;</span><span class="p">,</span> <span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lit</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># The output is a binary column containing the NDVI raster</span>
<span class="o">+------------------------------+</span>
<span class="o">|</span> <span class="n">compute_ndvi</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>   <span class="o">|</span>
<span class="o">+------------------------------+</span>
<span class="o">|</span> <span class="mi">000000</span> <span class="o">...</span> <span class="mi">00000000000000000</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">000000</span> <span class="o">...</span> <span class="mi">00000000000000000</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">000000</span> <span class="o">...</span> <span class="mi">00000000000000000</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                          <span class="o">|</span>
<span class="o">+------------------------------+</span>

<span class="c1"># We can update the tile column with the NDVI raster in place as well</span>
<span class="c1"># This will overwrite the existing raster field in the tile column</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">withField</span><span class="p">(</span><span class="s2">&quot;raster&quot;</span><span class="p">,</span> <span class="n">compute_ndvi</span><span class="p">(</span><span class="s2">&quot;tile.raster&quot;</span><span class="p">,</span> <span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lit</span><span class="p">(</span><span class="mi">2</span><span class="p">))))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span>                                                      <span class="n">path</span> <span class="o">|</span>             <span class="n">modificationTime</span> <span class="o">|</span>    <span class="n">length</span> <span class="o">|</span>                <span class="n">uuid</span> <span class="o">|</span> <span class="n">ySize</span> <span class="o">|</span> <span class="n">xSize</span> <span class="o">|</span> <span class="n">bandCount</span> <span class="o">|</span>             <span class="n">metadata</span> <span class="o">|</span> <span class="n">subdatasets</span> <span class="o">|</span>  <span class="n">srid</span> <span class="o">|</span>                                                                                                          <span class="n">tile</span> <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">424495268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660514</span> <span class="o">|</span> <span class="mi">7836235824828840960</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097928191</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">524425268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">212060218</span> <span class="o">|</span> <span class="mi">7836235824828840961</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097927192</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/</span><span class="mf">1241323268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660897</span> <span class="o">|</span> <span class="mi">7836235824828840962</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097929991</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                                                       <span class="o">|</span> <span class="o">...</span>                          <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                 <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                  <span class="o">|</span> <span class="o">...</span>         <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>                                                                                                           <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
</pre></div>
</div>
</section>
<section id="udf-example-for-writing-raster-files-to-disk">
<h2>UDF example for writing raster files to disk<a class="headerlink" href="#udf-example-for-writing-raster-files-to-disk" title="Permalink to this heading"></a></h2>
<p>In this example we will show how to write a raster file to disk using Rasterio Python API.
This is an examples showing how to materialize a raster binary object as a raster file on disk.
The format of the output file should match the driver format of the binary object.</p>
<p>Firstly we will create a spark DataFrame from a directory of raster files.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;gdal&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;dbfs:/path/to/raster/files&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span>                                                      <span class="n">path</span> <span class="o">|</span>             <span class="n">modificationTime</span> <span class="o">|</span>    <span class="n">length</span> <span class="o">|</span>                <span class="n">uuid</span> <span class="o">|</span> <span class="n">ySize</span> <span class="o">|</span> <span class="n">xSize</span> <span class="o">|</span> <span class="n">bandCount</span> <span class="o">|</span>             <span class="n">metadata</span> <span class="o">|</span> <span class="n">subdatasets</span> <span class="o">|</span>  <span class="n">srid</span> <span class="o">|</span>                                                                                                          <span class="n">tile</span> <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">424495268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660514</span> <span class="o">|</span> <span class="mi">7836235824828840960</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097928191</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">524425268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">212060218</span> <span class="o">|</span> <span class="mi">7836235824828840961</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097927192</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/</span><span class="mf">1241323268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660897</span> <span class="o">|</span> <span class="mi">7836235824828840962</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097929991</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                                                       <span class="o">|</span> <span class="o">...</span>                          <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                 <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                  <span class="o">|</span> <span class="o">...</span>         <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>                                                                                                           <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
</pre></div>
</div>
<p>Next we will define a function that will write a given raster file to disk. A “gotcha” to keep in mind is that you do
not want to have a file context manager open when you go to write out its context as the context manager will not yet
have been flushed. Another “gotcha” might be that the raster dataset does not have CRS included; if this arises, we
recommend adjusting the function to specify the CRS and set it on the dst variable, more at
<a class="reference external" href="https://rasterio.readthedocs.io/en/stable/api/rasterio.crs.html">rasterio.crs</a>. We would also point out that notional
“file_id” param can be constructed as a repeatable name from other field(s) in your dataframe / table or be random,
depending on your needs.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@udf</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">write_raster</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">file_id</span><span class="p">,</span> <span class="n">fuse_dir</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
    <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
    <span class="kn">from</span> <span class="nn">rasterio.io</span> <span class="kn">import</span> <span class="n">MemoryFile</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">rasterio</span>
    <span class="kn">import</span> <span class="nn">shutil</span>
    <span class="kn">import</span> <span class="nn">tempfile</span>

    <span class="c1"># - [1] populate the initial profile</span>
    <span class="c1"># # profile is needed in order to georeference the image</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmp_dir</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">data_arr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="n">MemoryFile</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">raster</span><span class="p">))</span> <span class="k">as</span> <span class="n">memfile</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">memfile</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">dataset</span><span class="p">:</span>
                <span class="n">profile</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">profile</span>
                <span class="n">data_arr</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># here you can update profile using .update method</span>
        <span class="c1"># example https://rasterio.readthedocs.io/en/latest/topics/writing.html</span>
        <span class="c1"># - [2] get the correct extension</span>
        <span class="n">extensions_map</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">drivers</span><span class="o">.</span><span class="n">raster_driver_extensions</span><span class="p">()</span>
        <span class="n">driver_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extensions_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="n">driver_map</span><span class="p">[</span><span class="n">driver</span><span class="p">]</span> <span class="c1">#e.g. GTiff</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># - [3] write local raster</span>
        <span class="c1"># - this is showing a single band [1]</span>
        <span class="c1">#   being written</span>
        <span class="n">tmp_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
          <span class="n">tmp_path</span><span class="p">,</span>
          <span class="s2">&quot;w&quot;</span><span class="p">,</span>
          <span class="o">**</span><span class="n">profile</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data_arr</span><span class="p">)</span> <span class="c1"># &lt;- adjust as needed</span>
        <span class="c1"># - [4] copy to fuse path</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">fuse_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fuse_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fuse_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fuse_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">fuse_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fuse_path</span>
</pre></div>
</div>
<p>Finally we will apply the function to the DataFrame.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
  <span class="n">write_raster</span><span class="p">(</span>
    <span class="s2">&quot;tile.raster&quot;</span><span class="p">,</span>
    <span class="n">lit</span><span class="p">(</span><span class="s2">&quot;GTiff&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;driver&quot;</span><span class="p">),</span>
    <span class="s2">&quot;uuid&quot;</span><span class="p">,</span>
    <span class="n">lit</span><span class="p">(</span><span class="s2">&quot;/dbfs/path/to/output/dir&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;fuse_dir&quot;</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
<span class="o">+----------------------------------------------+</span>
<span class="o">|</span> <span class="n">write_raster</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">fuse_dir</span><span class="p">)</span> <span class="o">|</span>
<span class="o">+----------------------------------------------+</span>
<span class="o">|</span> <span class="o">/</span><span class="n">dbfs</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="nb">dir</span><span class="o">/</span><span class="mf">1234.</span><span class="n">tif</span>            <span class="o">|</span>
<span class="o">|</span> <span class="o">/</span><span class="n">dbfs</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="nb">dir</span><span class="o">/</span><span class="mf">4545.</span><span class="n">tif</span>            <span class="o">|</span>
<span class="o">|</span> <span class="o">/</span><span class="n">dbfs</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="nb">dir</span><span class="o">/</span><span class="mf">3215.</span><span class="n">tif</span>            <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                                          <span class="o">|</span>
<span class="o">+----------------------------------------------+</span>
</pre></div>
</div>
<p>Sometimes you don’t need to be quite as fancy. Consider when you simply want to specify to write out raster contents,
assuming you specify the extension in the file_name. This is just writing binary column to file, nothing further. Again,
we use a notional “uuid” column as part of “file_name” param, which would have the same considerations as mentioned
above.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@udf</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">write_binary</span><span class="p">(</span><span class="n">raster_bin</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">fuse_dir</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">shutil</span>
    <span class="kn">import</span> <span class="nn">tempfile</span>

    <span class="n">Path</span><span class="p">(</span><span class="n">fuse_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fuse_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fuse_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fuse_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmp_dir</span><span class="p">:</span>
            <span class="n">tmp_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># - write within the tmp_dir context</span>
            <span class="c1"># - flush the writer before copy</span>
            <span class="n">tmp_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
            <span class="n">tmp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raster_bin</span><span class="p">)</span>  <span class="c1"># &lt;- write entire binary content</span>
            <span class="n">tmp_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c1"># - copy local to fuse</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">fuse_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fuse_path</span>
</pre></div>
</div>
<p>Finally we will apply the function to the DataFrame.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
  <span class="n">write_binary</span><span class="p">(</span>
    <span class="s2">&quot;tile.raster&quot;</span><span class="p">,</span>
    <span class="n">F</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;file_name&quot;</span><span class="p">),</span>
    <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;/dbfs/path/to/output/dir&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;fuse_dir&quot;</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
<span class="o">+-------------------------------------------+</span>
<span class="o">|</span> <span class="n">write_binary</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">fuse_dir</span><span class="p">)</span> <span class="o">|</span>
<span class="o">+-------------------------------------------+</span>
<span class="o">|</span> <span class="o">/</span><span class="n">dbfs</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="nb">dir</span><span class="o">/</span><span class="mf">1234.</span><span class="n">tif</span>         <span class="o">|</span>
<span class="o">|</span> <span class="o">/</span><span class="n">dbfs</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="nb">dir</span><span class="o">/</span><span class="mf">4545.</span><span class="n">tif</span>         <span class="o">|</span>
<span class="o">|</span> <span class="o">/</span><span class="n">dbfs</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="nb">dir</span><span class="o">/</span><span class="mf">3215.</span><span class="n">tif</span>         <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                                       <span class="o">|</span>
<span class="o">+-------------------------------------------+</span>
</pre></div>
</div>
</section>
<section id="udf-example-for-generating-google-maps-compatible-tiles">
<h2>UDF example for generating Google Maps compatible tiles<a class="headerlink" href="#udf-example-for-generating-google-maps-compatible-tiles" title="Permalink to this heading"></a></h2>
<p>Delta Tables can be used as the basis for serving pre-generated tiles as an option. Here is an example UDF that applies
a few gdal operations on each band, to write to Google Maps Compatible tiles transformed into 3857 (Web Mercator). Note:
the ‘quadbin’ column shown in this example was generated separately using CARTO’s <a class="reference external" href="https://pypi.org/project/quadbin/">quadbin</a>
package. You can replace the calls with whatever you need to do. The output structure looks something like the following:</p>
<figure class="doc-figure align-default">
<img alt="../_images/quadbin.png" src="../_images/quadbin.png" />
</figure>
<p>The UDF example sets raster extent, block size, and interpolation. It specifies source SRID as 4326;
additionally, output type and nodata values are specified. COG overviews are not generated
nor is an ALPHA band, but they could be. Again, you would modify this example to suit your needs.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@udf</span><span class="p">(</span><span class="s2">&quot;binary&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">transform_raw_raster</span><span class="p">(</span><span class="n">raster</span><span class="p">):</span>
 <span class="kn">import</span> <span class="nn">tempfile</span>
 <span class="kn">import</span> <span class="nn">uuid</span>
 <span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span>

 <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmp_dir</span><span class="p">:</span>
   <span class="n">fn1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="si">}</span><span class="s2">.tif&quot;</span>
   <span class="n">fn2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="si">}</span><span class="s2">.tif&quot;</span>
   <span class="n">fn3</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="si">}</span><span class="s2">.tif&quot;</span>
   <span class="n">fn4</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="si">}</span><span class="s2">.tif&quot;</span>

   <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn1</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
     <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>

   <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">fn2</span><span class="p">,</span> <span class="n">fn1</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="s2">&quot;-of GTiff -a_ullr -180 90 180 -90 -a_nodata -32767 -ot Int16&quot;</span><span class="p">)</span>
   <span class="n">gdal</span><span class="o">.</span><span class="n">Warp</span><span class="p">(</span><span class="n">fn3</span><span class="p">,</span> <span class="n">fn2</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span> <span class="s2">&quot;-tr 0.125 -0.125 -r cubicspline&quot;</span><span class="p">)</span>
   <span class="n">gdal</span><span class="o">.</span><span class="n">Warp</span><span class="p">(</span><span class="n">fn4</span><span class="p">,</span> <span class="n">fn3</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span> <span class="s2">&quot;-of COG -co BLOCKSIZE=1024 -co TILING_SCHEME=GoogleMapsCompatible -co COMPRESS=DEFLATE -co OVERVIEWS=NONE -co ADD_ALPHA=NO -co RESAMPLING=cubicspline -s_srs EPSG:4326&quot;</span><span class="p">)</span>

   <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn4</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
     <span class="n">res</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
   <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
<p>Example of calling the UDF (original data was NetCDF). If you have more than 1 band, this assumes <code class="code docutils literal notranslate"><span class="pre">transform_raw_rasters</span></code> UDF is called after
<code class="code docutils literal notranslate"><span class="pre">rst_separatebands</span></code> function (or you could potentially modify the UDF to operate on multiple bands).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">base_table</span> <span class="o">=</span> <span class="p">(</span>
 <span class="n">df</span>
   <span class="o">.</span><span class="n">select</span><span class="p">(</span>
     <span class="s2">&quot;path&quot;</span><span class="p">,</span>
     <span class="s2">&quot;metadata&quot;</span><span class="p">,</span>
     <span class="s2">&quot;tile&quot;</span>
   <span class="p">)</span>
   <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;subdatasets&quot;</span><span class="p">,</span> <span class="n">mos</span><span class="o">.</span><span class="n">rst_subdatasets</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">))</span>
   <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">array_contains</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">map_values</span><span class="p">(</span><span class="s2">&quot;subdatasets&quot;</span><span class="p">),</span> <span class="s2">&quot;sfcWind&quot;</span><span class="p">))</span>
   <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">,</span> <span class="n">mos</span><span class="o">.</span><span class="n">rst_getsubdataset</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;sfcWind&quot;</span><span class="p">)))</span>
   <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">,</span> <span class="n">mos</span><span class="o">.</span><span class="n">rst_separatebands</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">))</span>
   <span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">defaultParallelism</span><span class="p">)</span>
   <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
     <span class="s2">&quot;tile&quot;</span><span class="p">,</span>
     <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">withField</span><span class="p">(</span><span class="s2">&quot;raster&quot;</span><span class="p">,</span> <span class="n">transform_raw_raster</span><span class="p">(</span><span class="s2">&quot;tile.raster&quot;</span><span class="p">))</span>
       <span class="o">.</span><span class="n">withField</span><span class="p">(</span>
         <span class="s2">&quot;metadata&quot;</span><span class="p">,</span>
         <span class="n">F</span><span class="o">.</span><span class="n">map_concat</span><span class="p">(</span><span class="s2">&quot;tile.metadata&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">create_map</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;driver&quot;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;GTiff&quot;</span><span class="p">)))</span>
       <span class="p">)</span>
   <span class="p">)</span>
   <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;srid&quot;</span><span class="p">,</span> <span class="n">mos</span><span class="o">.</span><span class="n">rst_srid</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">))</span>
   <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;srid&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;srid&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">4326</span><span class="p">))</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;srid&quot;</span><span class="p">)))</span>
   <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;timestep&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">element_at</span><span class="p">(</span><span class="n">mos</span><span class="o">.</span><span class="n">rst_metadata</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">),</span> <span class="s2">&quot;NC_GLOBAL#GDAL_MOSAIC_BAND_INDEX&quot;</span><span class="p">))</span>
   <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">,</span> <span class="n">mos</span><span class="o">.</span><span class="n">rst_transform</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">3857</span><span class="p">)))</span>
   <span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">defaultParallelism</span><span class="p">,</span> <span class="s2">&quot;timestep&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="raster-functions.html" class="btn btn-neutral float-left" title="Raster functions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../usage/usage.html" class="btn btn-neutral float-right" title="Usage" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Databricks Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>