<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rasterio UDFs &mdash; Mosaic</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Usage" href="../usage/usage.html" />
    <link rel="prev" title="Raster functions" href="raster-functions.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Mosaic
              <img src="../_static/mosaic_logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="api.html">API Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="vector-format-readers.html">Vector Format Readers</a></li>
<li class="toctree-l2"><a class="reference internal" href="raster-format-readers.html">Raster Format Readers</a></li>
<li class="toctree-l2"><a class="reference internal" href="geometry-constructors.html">Geometry constructors</a></li>
<li class="toctree-l2"><a class="reference internal" href="geometry-accessors.html">Geometry accessors</a></li>
<li class="toctree-l2"><a class="reference internal" href="spatial-functions.html">Spatial functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="spatial-indexing.html">Spatial grid indexing</a></li>
<li class="toctree-l2"><a class="reference internal" href="spatial-predicates.html">Spatial predicates</a></li>
<li class="toctree-l2"><a class="reference internal" href="spatial-aggregations.html">Spatial aggregation functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="raster-functions.html">Raster functions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Rasterio UDFs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../usage/usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../literature/videos.html">Mosaic Videos and Talks</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Mosaic</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="api.html">API Documentation</a></li>
      <li class="breadcrumb-item active">Rasterio UDFs</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/api/rasterio-udfs.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="rasterio-udfs">
<h1>Rasterio UDFs<a class="headerlink" href="#rasterio-udfs" title="Permalink to this heading"></a></h1>
<section id="intro">
<h2>Intro<a class="headerlink" href="#intro" title="Permalink to this heading"></a></h2>
<p>Rasterio (<a class="reference external" href="https://rasterio.readthedocs.io/en/latest/">https://rasterio.readthedocs.io/en/latest/</a>) is a Python library for reading and writing geospatial raster datasets.
It uses GDAL (<a class="reference external" href="https://gdal.org/">https://gdal.org/</a>) for file I/O and raster formatting and provides a Python API for GDAL functions.
It is a great library for working with raster data in Python and it is a popular choice for many geospatial data scientists.
Rasterio UDFs provide a way to use Rasterio Python API in Spark for distributed processing of raster data.
The data structures used by Mosaic are compatible with Rasterio and can be used interchangeably.
In this section we will show how to use Rasterio UDFs to process raster data in Mosaic + Spark.
We assume that you have a basic understanding of Rasterio and GDAL.</p>
<p>Please note that we advise the users to set these configuration to ensure proper distribution.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.execution.arrow.enabled&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.execution.arrow.maxRecordsPerBatch&quot;</span><span class="p">,</span> <span class="s2">&quot;1024&quot;</span><span class="p">)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.execution.arrow.fallback.enabled&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.adaptive.coalescePartitions.enabled&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.shuffle.partitions&quot;</span><span class="p">,</span> <span class="s2">&quot;400&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="rasterio-raster-plotting">
<h2>Rasterio raster plotting<a class="headerlink" href="#rasterio-raster-plotting" title="Permalink to this heading"></a></h2>
<p>In this example we will show how to plot a raster file using Rasterio Python API.</p>
<p>Firstly we will create a spark DataFrame from a directory of raster files.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;gdal&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;dbfs:/path/to/raster/files&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span>                                                      <span class="n">path</span> <span class="o">|</span>             <span class="n">modificationTime</span> <span class="o">|</span>    <span class="n">length</span> <span class="o">|</span>                <span class="n">uuid</span> <span class="o">|</span> <span class="n">ySize</span> <span class="o">|</span> <span class="n">xSize</span> <span class="o">|</span> <span class="n">bandCount</span> <span class="o">|</span>             <span class="n">metadata</span> <span class="o">|</span> <span class="n">subdatasets</span> <span class="o">|</span>  <span class="n">srid</span> <span class="o">|</span>                                                                                                          <span class="n">tile</span> <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">424495268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660514</span> <span class="o">|</span> <span class="mi">7836235824828840960</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097928191</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">524425268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">212060218</span> <span class="o">|</span> <span class="mi">7836235824828840961</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097927192</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/</span><span class="mf">1241323268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660897</span> <span class="o">|</span> <span class="mi">7836235824828840962</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097929991</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                                                       <span class="o">|</span> <span class="o">...</span>                          <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                 <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                  <span class="o">|</span> <span class="o">...</span>         <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>                                                                                                           <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
</pre></div>
</div>
<p>Next we will define a function that will plot a given raster file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.io</span> <span class="kn">import</span> <span class="n">MemoryFile</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>

<span class="k">def</span> <span class="nf">plot_raster</span><span class="p">(</span><span class="n">raster</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">MemoryFile</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">raster</span><span class="p">))</span> <span class="k">as</span> <span class="n">memfile</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">memfile</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">show</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>Finally we will apply the function to the DataFrame collected results.
Note that in order to plot the raster we need to collect the results to the driver.
Please apply reasonable filters to the DataFrame before collecting the results.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plot_raster</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;tile&quot;</span><span class="p">][</span><span class="s2">&quot;raster&quot;</span><span class="p">])</span>
</pre></div>
</div>
<figure class="doc-figure align-default" id="id1">
<img alt="../_images/plot_raster.png" src="../_images/plot_raster.png" />
<figcaption>
<p><span class="caption-text">Fig 1. Plot raster using Rasterio Python API</span><a class="headerlink" href="#id1" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="udf-example-for-computing-band-statistics">
<h2>UDF example for computing band statistics<a class="headerlink" href="#udf-example-for-computing-band-statistics" title="Permalink to this heading"></a></h2>
<p>In this example we will show how to compute band statistics for a raster file.</p>
<p>Firstly we will create a spark DataFrame from a directory of raster files.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;gdal&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;dbfs:/path/to/raster/files&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span>                                                      <span class="n">path</span> <span class="o">|</span>             <span class="n">modificationTime</span> <span class="o">|</span>    <span class="n">length</span> <span class="o">|</span>                <span class="n">uuid</span> <span class="o">|</span> <span class="n">ySize</span> <span class="o">|</span> <span class="n">xSize</span> <span class="o">|</span> <span class="n">bandCount</span> <span class="o">|</span>             <span class="n">metadata</span> <span class="o">|</span> <span class="n">subdatasets</span> <span class="o">|</span>  <span class="n">srid</span> <span class="o">|</span>                                                                                                          <span class="n">tile</span> <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">424495268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660514</span> <span class="o">|</span> <span class="mi">7836235824828840960</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097928191</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">524425268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">212060218</span> <span class="o">|</span> <span class="mi">7836235824828840961</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097927192</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/</span><span class="mf">1241323268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660897</span> <span class="o">|</span> <span class="mi">7836235824828840962</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097929991</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                                                       <span class="o">|</span> <span class="o">...</span>                          <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                 <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                  <span class="o">|</span> <span class="o">...</span>         <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>                                                                                                           <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
</pre></div>
</div>
<p>Next we will define a function that will compute band statistics for a given raster file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.io</span> <span class="kn">import</span> <span class="n">MemoryFile</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>

<span class="nd">@udf</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_band_mean</span><span class="p">(</span><span class="n">raster</span><span class="p">):</span>
  <span class="k">with</span> <span class="n">MemoryFile</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">raster</span><span class="p">))</span> <span class="k">as</span> <span class="n">memfile</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">memfile</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">dataset</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span><span class="n">bidx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span>
</pre></div>
</div>
<p>Finally we will apply the function to the DataFrame.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">compute_band_mean</span><span class="p">(</span><span class="s2">&quot;tile.raster&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="o">+---------------------------+</span>
<span class="o">|</span> <span class="n">compute_band_mean</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span> <span class="o">|</span>
<span class="o">+---------------------------+</span>
<span class="o">|</span>         <span class="mf">0.0111000000000000</span><span class="o">|</span>
<span class="o">|</span>         <span class="mf">0.0021000000000000</span><span class="o">|</span>
<span class="o">|</span>         <span class="mf">0.3001000000000000</span><span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                       <span class="o">|</span>
<span class="o">+---------------------------+</span>
</pre></div>
</div>
</section>
<section id="udf-example-for-computing-ndvi">
<h2>UDF example for computing NDVI<a class="headerlink" href="#udf-example-for-computing-ndvi" title="Permalink to this heading"></a></h2>
<p>In this example we will show how to compute NDVI for a raster file.
NDVI is a common index used to assess vegetation health.
It is computed as follows: ndvi = (nir - red) / (nir + red).
NDVI output is a single band raster file with values in the range [-1, 1].
We will show how to return a raster object as a result of a UDF.</p>
<p>Firstly we will create a spark DataFrame from a directory of raster files.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;gdal&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;dbfs:/path/to/raster/files&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span>                                                      <span class="n">path</span> <span class="o">|</span>             <span class="n">modificationTime</span> <span class="o">|</span>    <span class="n">length</span> <span class="o">|</span>                <span class="n">uuid</span> <span class="o">|</span> <span class="n">ySize</span> <span class="o">|</span> <span class="n">xSize</span> <span class="o">|</span> <span class="n">bandCount</span> <span class="o">|</span>             <span class="n">metadata</span> <span class="o">|</span> <span class="n">subdatasets</span> <span class="o">|</span>  <span class="n">srid</span> <span class="o">|</span>                                                                                                          <span class="n">tile</span> <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">424495268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660514</span> <span class="o">|</span> <span class="mi">7836235824828840960</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097928191</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">524425268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">212060218</span> <span class="o">|</span> <span class="mi">7836235824828840961</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097927192</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/</span><span class="mf">1241323268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660897</span> <span class="o">|</span> <span class="mi">7836235824828840962</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097929991</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                                                       <span class="o">|</span> <span class="o">...</span>                          <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                 <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                  <span class="o">|</span> <span class="o">...</span>         <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>                                                                                                           <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
</pre></div>
</div>
<p>Next we will define a function that will compute NDVI for a given raster file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.io</span> <span class="kn">import</span> <span class="n">MemoryFile</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>

<span class="nd">@udf</span><span class="p">(</span><span class="s2">&quot;binary&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_ndvi</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">nir_band</span><span class="p">,</span> <span class="n">red_band</span><span class="p">):</span>
  <span class="k">with</span> <span class="n">MemoryFile</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">raster</span><span class="p">))</span> <span class="k">as</span> <span class="n">memfile</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">memfile</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">dataset</span><span class="p">:</span>
      <span class="n">red</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">red_band</span><span class="p">)</span>
      <span class="n">nir</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nir_band</span><span class="p">)</span>
      <span class="n">ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nir</span> <span class="o">-</span> <span class="n">red</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nir</span> <span class="o">+</span> <span class="n">red</span><span class="p">)</span>
      <span class="n">profile</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">profile</span>
      <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
      <span class="c1"># Write the NDVI to a tmp file and return it as binary</span>
      <span class="c1"># This is a workaround an issue occurring when using</span>
      <span class="c1"># MemoryFile for writing using an updated profile</span>
      <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
          <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ndvi</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">rasterio</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>Finally we will apply the function to the DataFrame.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">compute_ndvi</span><span class="p">(</span><span class="s2">&quot;tile.raster&quot;</span><span class="p">,</span> <span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lit</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># The output is a binary column containing the NDVI raster</span>
<span class="o">+------------------------------+</span>
<span class="o">|</span> <span class="n">compute_ndvi</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>   <span class="o">|</span>
<span class="o">+------------------------------+</span>
<span class="o">|</span> <span class="mi">000000</span> <span class="o">...</span> <span class="mi">00000000000000000</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">000000</span> <span class="o">...</span> <span class="mi">00000000000000000</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">000000</span> <span class="o">...</span> <span class="mi">00000000000000000</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                          <span class="o">|</span>
<span class="o">+------------------------------+</span>

<span class="c1"># We can update the tile column with the NDVI raster in place as well</span>
<span class="c1"># This will overwrite the existing raster field in the tile column</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">withField</span><span class="p">(</span><span class="s2">&quot;raster&quot;</span><span class="p">,</span> <span class="n">compute_ndvi</span><span class="p">(</span><span class="s2">&quot;tile.raster&quot;</span><span class="p">,</span> <span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lit</span><span class="p">(</span><span class="mi">2</span><span class="p">))))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span>                                                      <span class="n">path</span> <span class="o">|</span>             <span class="n">modificationTime</span> <span class="o">|</span>    <span class="n">length</span> <span class="o">|</span>                <span class="n">uuid</span> <span class="o">|</span> <span class="n">ySize</span> <span class="o">|</span> <span class="n">xSize</span> <span class="o">|</span> <span class="n">bandCount</span> <span class="o">|</span>             <span class="n">metadata</span> <span class="o">|</span> <span class="n">subdatasets</span> <span class="o">|</span>  <span class="n">srid</span> <span class="o">|</span>                                                                                                          <span class="n">tile</span> <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">424495268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660514</span> <span class="o">|</span> <span class="mi">7836235824828840960</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097928191</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">524425268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">212060218</span> <span class="o">|</span> <span class="mi">7836235824828840961</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097927192</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/</span><span class="mf">1241323268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660897</span> <span class="o">|</span> <span class="mi">7836235824828840962</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097929991</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                                                       <span class="o">|</span> <span class="o">...</span>                          <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                 <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                  <span class="o">|</span> <span class="o">...</span>         <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>                                                                                                           <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
</pre></div>
</div>
</section>
<section id="udf-example-for-writing-raster-files-to-disk">
<h2>UDF example for writing raster files to disk<a class="headerlink" href="#udf-example-for-writing-raster-files-to-disk" title="Permalink to this heading"></a></h2>
<p>In this example we will show how to write a raster file to disk using Rasterio Python API.
This is an examples showing how to materialize a raster binary object as a raster file on disk.
The format of the output file should match the driver format of the binary object.</p>
<p>Firstly we will create a spark DataFrame from a directory of raster files.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;gdal&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;dbfs:/path/to/raster/files&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span>                                                      <span class="n">path</span> <span class="o">|</span>             <span class="n">modificationTime</span> <span class="o">|</span>    <span class="n">length</span> <span class="o">|</span>                <span class="n">uuid</span> <span class="o">|</span> <span class="n">ySize</span> <span class="o">|</span> <span class="n">xSize</span> <span class="o">|</span> <span class="n">bandCount</span> <span class="o">|</span>             <span class="n">metadata</span> <span class="o">|</span> <span class="n">subdatasets</span> <span class="o">|</span>  <span class="n">srid</span> <span class="o">|</span>                                                                                                          <span class="n">tile</span> <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">424495268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660514</span> <span class="o">|</span> <span class="mi">7836235824828840960</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097928191</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/-</span><span class="mf">524425268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">212060218</span> <span class="o">|</span> <span class="mi">7836235824828840961</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097927192</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">FileStore</span><span class="o">/</span><span class="n">geospatial</span><span class="o">/</span><span class="n">odin</span><span class="o">/</span><span class="n">alaska</span><span class="o">/</span><span class="n">B02</span><span class="o">/</span><span class="mf">1241323268.</span><span class="n">tif</span> <span class="o">|</span> <span class="mi">1970</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.135</span><span class="o">+</span><span class="mi">0000</span> <span class="o">|</span> <span class="mi">211660897</span> <span class="o">|</span> <span class="mi">7836235824828840962</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span> <span class="mi">10980</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="p">{</span><span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Po</span><span class="o">...</span> <span class="o">|</span>          <span class="p">{}</span> <span class="o">|</span> <span class="mi">32602</span> <span class="o">|</span> <span class="p">{</span><span class="n">index_id</span><span class="p">:</span> <span class="mi">593308294097929991</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">01</span> <span class="mi">10</span> <span class="o">...</span> <span class="mi">00</span><span class="p">],</span> <span class="n">parentPath</span><span class="p">:</span> <span class="s2">&quot;dbfs:/path_to_file&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span> <span class="p">}</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                                                       <span class="o">|</span> <span class="o">...</span>                          <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                 <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span> <span class="o">...</span>                  <span class="o">|</span> <span class="o">...</span>         <span class="o">|</span> <span class="o">...</span>   <span class="o">|</span> <span class="o">...</span>                                                                                                           <span class="o">|</span>
<span class="o">+-----------------------------------------------------------+------------------------------+-----------+---------------------+-------+-------+-----------+----------------------+-------------+-------+---------------------------------------------------------------------------------------------------------------+</span>
</pre></div>
</div>
<p>Next we will define a function that will write a given raster file to disk.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.io</span> <span class="kn">import</span> <span class="n">MemoryFile</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="nd">@udf</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">write_raster</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">file_id</span><span class="p">,</span> <span class="n">parent_dir</span><span class="p">):</span>
  <span class="k">with</span> <span class="n">MemoryFile</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">raster</span><span class="p">))</span> <span class="k">as</span> <span class="n">memfile</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">memfile</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">dataset</span><span class="p">:</span>
      <span class="n">Path</span><span class="p">(</span><span class="n">outputpath</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">extensions_map</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">drivers</span><span class="o">.</span><span class="n">raster_driver_extensions</span><span class="p">()</span>
      <span class="n">driver_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extensions_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
      <span class="n">extension</span> <span class="o">=</span> <span class="n">driver_map</span><span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">driver</span><span class="p">]</span>
      <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parent_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="c1"># If you want to write the raster to a different format</span>
      <span class="c1"># you can update the profile here. Note that the extension</span>
      <span class="c1"># should match the driver format</span>
      <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">dataset</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">path</span>
</pre></div>
</div>
<p>Finally we will apply the function to the DataFrame.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">write_raster</span><span class="p">(</span><span class="s2">&quot;tile.raster&quot;</span><span class="p">,</span> <span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="n">lit</span><span class="p">(</span><span class="s2">&quot;dbfs:/path/to/output/dir&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="o">+-------------------------------------+</span>
<span class="o">|</span> <span class="n">write_raster</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span><span class="o">|</span>
<span class="o">+-------------------------------------+</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="nb">dir</span><span class="o">/</span><span class="mf">1234.</span><span class="n">tif</span>   <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="nb">dir</span><span class="o">/</span><span class="mf">4545.</span><span class="n">tif</span>   <span class="o">|</span>
<span class="o">|</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="nb">dir</span><span class="o">/</span><span class="mf">3215.</span><span class="n">tif</span>   <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>                                 <span class="o">|</span>
<span class="o">+-------------------------------------+</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="raster-functions.html" class="btn btn-neutral float-left" title="Raster functions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../usage/usage.html" class="btn btn-neutral float-right" title="Usage" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Databricks Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>